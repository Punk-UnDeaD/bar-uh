FROM php:8.0-fpm-alpine

USER root

RUN apk add --update --no-cache exiftool pngquant imagemagick

RUN apk update ;\
    apk add -t .run-deps \
        bash \
        curl \
        gzip \
        icu-libs \
        libzip \
        libuuid \
        nano \
        patch \
        postgresql-client \
        rabbitmq-c \
        tar \
        unzip \
        yaml \
        ;\
    apk add -t .build-deps \
        autoconf build-base pkgconfig m4 perl autoconf dpkg-dev dpkg re2c util-linux-dev \
        icu-dev \
        libzip-dev \
        postgresql-dev \
        rabbitmq-c-dev \
        yaml-dev; \
    docker-php-ext-install \
        intl \
        opcache \
        pdo_pgsql \
        pgsql \
        zip ;\
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/bin --filename=composer --quiet;\
    curl -L https://github.com/FriendsOfPHP/pickle/releases/latest/download/pickle.phar -o /usr/local/bin/pickle;\
        chmod +x /usr/local/bin/pickle ;\
    mkdir /tmp/amqp ;\
        curl -L https://github.com/php-amqp/php-amqp/archive/master.tar.gz | tar -xzC /tmp/amqp --strip-components=1 ;\
        unzip /tmp/amqp.zip -d /tmp/amqp;\
        cd /tmp/amqp; \
        phpize --clean ;\
        phpize;\
        ./configure;\
        make;\
        make install; \
    pickle install apcu ;\
    pickle install igbinary-3.1.5 ;\
    pickle install redis ;\
    pickle install uuid-1.2.0 ;\
    pickle install yaml ;\
    pickle install xdebug-3.0.2 ;\
    echo "extension=apcu.so" > /usr/local/etc/php/conf.d/docker-php-ext-apcu.ini ; \
    echo "extension=amqp.so" > /usr/local/etc/php/conf.d/docker-php-ext-amqp.ini ; \
    echo "extension=igbinary.so" > /usr/local/etc/php/conf.d/docker-php-ext-igbinary.ini ; \
    echo "extension=redis.so" > /usr/local/etc/php/conf.d/docker-php-ext-redis.ini ; \
    echo "zend_extension=xdebug.so" > /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini ;\
    echo "extension=uuid.so" > /usr/local/etc/php/conf.d/docker-php-ext-uuid.ini ; \
    echo "extension=yaml.so" > /usr/local/etc/php/conf.d/docker-php-ext-yaml.ini ; \
    cd / ;\
    rm -rf /tmp/* ;\
    rm -rf /var/cache/apk/* ;\
    docker-php-source delete;\
    apk del --purge .build-deps
